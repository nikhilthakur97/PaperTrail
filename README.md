# PaperTrail ‚Äì Research RAG Chat Application

üåê **Live Demo**: [https://paper-trail-sooty.vercel.app](https://paper-trail-sooty.vercel.app)

## Overview

PaperTrail is a Retrieval‚ÄëAugmented Generation (RAG) conversational app that answers research questions using articles from **PubMed** and **arXiv**, plus **user‚Äëuploaded** documents. It streams well‚Äëformatted Markdown responses, attaches evidence, and lets users download answers and cited sources.

## Features ‚ú®

### ‚úÖ Application Requirements Met

* **‚úì User Signup and Login**: Email/password authentication + Google OAuth
* **‚úì Chat UI**: Interactive chat interface with real-time message streaming
* **‚úì Response Streaming**: Live token streaming with proper Markdown formatting (tables, code blocks, lists, syntax highlighting)
* **‚úì File Download**: Export answers as PDF/MD/TXT, download references as CSV, bundle source PDFs
* **‚úì Message History Management**: Threaded conversations with full replay capability

### Additional Features

* **Unified RAG**: PubMed + arXiv + user uploads with citations
* **PDF Upload & Processing**: Drop PDFs to add them to your knowledge base
* **Multimodal Analysis**: Automatically extracts and analyzes tables, charts, and diagrams from PDFs using Gemini Vision
* **Interactive Charts**: AI generates pie, bar, and line charts from table data with Chart.js
* **Citation Tracking**: Every answer includes references to source materials
* **Cloud‚ÄëAgnostic**: Fully containerized and portable to any cloud provider

## Architecture (Single Next.js App)

PaperTrail runs **entirely inside one Next.js application**. There is **no separate background worker service**. Background tasks are executed by a **job runner inside the same Next.js deployment**.

### Components

* **Next.js Web + API**

  * React UI (App Router) with chat, history, uploads, and downloads.
  * **Route Handlers** for: auth, chat (SSE), ingestion triggers, uploads, downloads, and job status.
  * **Job Runner (in‚Äëapp)**: A Node runtime process initialized during app start that processes queued tasks (ingestion, parsing, chunking, embedding, artifact generation). It runs in the same container/pod as the web server.
* **Datastores**

  * **Postgres**: user/auth, threads/messages, document catalog, job metadata.
  * **Vector Store**: Qdrant or Postgres+pgvector for embeddings + metadata.
  * **Object Storage**: MinIO (S3‚Äëcompatible) for originals and generated files.
* **Queue**

  * Redis (or an equivalent in‚Äëprocess scheduler) to enqueue jobs and schedule periodic ingestion. The queue client is initialized by the Next.js app; processors run in the same deployment.

### Data Flow

1. **Corpus Ingestion (PubMed/arXiv)**

   * Ingestion is triggered either by a scheduled job or an on‚Äëdemand API call.
   * Fetch metadata (PMID/PMC ID/arXiv ID, title, authors, year, URLs/DOI, license) and, where permitted, full text PDFs.
   * Normalize to clean text/Markdown, retain provenance and licensing.
   * Chunk + embed; upsert to the vector store and record metadata in Postgres; store originals in MinIO.

2. **User Uploads**

   * Files are uploaded via the chat UI and stored in MinIO.
   * The in‚Äëapp job runner extracts text ‚Üí chunks ‚Üí embeds ‚Üí indexes into the same collection, tagged as `user_upload` (and optionally `thread_id`).

3. **Chat Retrieval & Answering**

   * The chat API performs **hybrid retrieval** (dense + sparse) across all sources with optional filters (year, source, topic).
   * Selected chunks + metadata are packaged as context; the LLM streams a grounded Markdown answer via **SSE**.
   * Jobs for **References.csv**, **Sources.zip** (if licenses allow), and **Answer PDF** are queued and fulfilled by the in‚Äëapp runner; download links appear in the UI when ready.

4. **History & Auditing**

   * Messages, citations, and artifact paths are persisted in Postgres and surfaced in the history view; conversations can be replayed without re‚Äëcomputation.

## Operations (Single Deployment)

* **Process Model**: One Next.js deployment that initializes both the HTTP server and the job processors. Jobs run off the same codebase and environment.
* **Scheduling**: Repeatable jobs (e.g., nightly ingestion refresh) are registered at boot and executed by the in‚Äëapp runner.
* **Backpressure**: Queue concurrency limits ensure heavy tasks don‚Äôt interfere with request latency.
* **Idempotency**: Document hashing (e.g., by DOI/ID + content hash) avoids duplicate indexing.
* **Licensing**: Respect open‚Äëaccess terms; disable PDF packaging if license disallows redistribution.

## Downloads & Evidence

* **Answer Export**: PDF/MD/TXT of the final assistant message.
* **References.csv**: Titles, authors, year, IDs (PMID/PMC/arXiv/DOI), and links for all citations.
* **Sources.zip**: Bundle of cited PDFs when licenses allow; otherwise provide links only.

## Evaluation Criteria Mapping

* **Accuracy**: Hybrid retrieval + reranking, section‚Äëaware chunking, strict citation prompts; fallbacks for low‚Äëconfidence answers.
* **UI Creativity**: Streaming Markdown with citation drawer, per‚Äëmessage downloads, and replayable history.
* **Architecture & Scalability**: Single Next.js app with an internal job runner, Redis‚Äëbacked queue, and portable services (Postgres, Vector DB, MinIO). Can be split into separate services later without redesign.

## Tech Stack üõ†Ô∏è

### ‚úÖ Tech Stack Requirements Met

* **‚úì Frontend**: Next.js 15 (App Router) with React 19
* **‚úì Backend**: Node.js with Next.js API routes
* **‚úì Database**: PostgreSQL (Neon serverless) with Drizzle ORM
* **‚úì Vector Store**: Prepared for Qdrant or pgvector integration
* **‚úì Authentication**: NextAuth v5 (Google OAuth + email/password)
* **‚úì LLM**: Azure OpenAI (GPT-4o-mini) with streaming support
* **‚úì UI**: Tailwind CSS 4, Radix UI, react-markdown with syntax highlighting

### Additional Technologies

* **Email**: Nodemailer/Resend for verification emails
* **PDF Processing**: pdf-parse-fork for text extraction, pdf-lib for image extraction
* **Multimodal AI**: Gemini Vision API for analyzing tables, charts, and diagrams
* **Chart Rendering**: Chart.js with react-chartjs-2 for interactive visualizations
* **Markdown Rendering**: remark-gfm (tables, task lists) + rehype-highlight
* **Deployment**: Docker, Vercel (cloud-agnostic)

## Getting Started üöÄ

### Prerequisites

* Node.js 18+ and npm
* PostgreSQL database (we recommend [Neon](https://neon.tech) for serverless)
* Azure OpenAI API key or use the provided credentials

### Environment Variables

Create a `.env` file in the root directory (use `.env.example` as template):

```bash
# Database
DATABASE_URL=postgresql://user:password@host:5432/papertrail

# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your_nextauth_secret_here

# Google OAuth (optional)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret

# Email Service (optional)
RESEND_API_KEY=your_resend_api_key
EMAIL_SERVICE=gmail
EMAIL_USER=your_email@gmail.com
EMAIL_PASSWORD=your_email_password

# AI Services
GEMINI_API_KEY=your_gemini_api_key
AZURE_OPENAI_API_KEY=your_azure_api_key
AZURE_OPENAI_ENDPOINT=https://your-endpoint.cognitiveservices.azure.com/
AZURE_OPENAI_DEPLOYMENT=gpt-4o-mini
AZURE_OPENAI_API_VERSION=2024-04-01-preview
HUGGINGFACE_API_KEY=your_huggingface_api_key
```

### Running Locally

1. **Clone the repository**

```bash
git clone <repository-url>
cd PaperTrail
```

2. **Install dependencies**

```bash
npm install
```

3. **Set up environment variables**

```bash
cp .env.example .env
# Edit .env with your credentials
```

4. **Set up the database**

```bash
# Generate and run migrations
npx drizzle-kit generate
npx drizzle-kit migrate

# OR push schema directly (for development)
npx drizzle-kit push
```

5. **Start the development server**

```bash
npm run dev
```

6. **Open your browser**

Navigate to [http://localhost:3000](http://localhost:3000)

### Running with Docker üê≥

1. **Create `.env` file with your configuration**

2. **Build and run with Docker Compose**

```bash
docker-compose up --build
```

3. **Access the application**

Navigate to [http://localhost:3000](http://localhost:3000)

The Docker setup includes:
- Next.js application container
- Automatic environment variable injection
- Hot reload support for development
- Production-ready build optimization

### Database Management

**Drizzle Studio** - Visual database explorer:

```bash
npx drizzle-kit studio
```

Opens at [https://local.drizzle.studio](https://local.drizzle.studio)

**Common Drizzle Commands**:

```bash
npx drizzle-kit generate    # Generate new migration from schema changes
npx drizzle-kit migrate     # Apply pending migrations
npx drizzle-kit push        # Push schema directly to DB (dev only)
```

## Deployment üåê

### ‚úÖ Deployment Requirements Met

* **‚úì Containerized**: Dockerized application with `Dockerfile` and `docker-compose.yml`
* **‚úì Cloud Agnostic**: Works on any cloud provider (Vercel, AWS, GCP, Azure, etc.)
* **‚úì Production Ready**: Standalone Next.js build, optimized for containers

### Live Deployment

**Production URL**: [https://paper-trail-sooty.vercel.app](https://paper-trail-sooty.vercel.app)

Deployed on Vercel with:
- Neon PostgreSQL (serverless)
- Edge-optimized functions
- Automatic SSL/HTTPS
- Global CDN distribution

### Deploy Your Own

**Vercel** (Recommended):

```bash
npm i -g vercel
vercel
```

**Docker** (Any Cloud):

```bash
docker build -t papertrail .
docker run -p 3000:3000 --env-file .env papertrail
```

**Kubernetes**:

Use the provided `Dockerfile` with your K8s deployment manifests.

## Evaluation Criteria ‚úÖ

### Accuracy of Responses
- ‚úÖ Hybrid retrieval (dense + sparse search)
- ‚úÖ Section-aware chunking for better context
- ‚úÖ Strict citation prompts with source attribution
- ‚úÖ Fallback handling for low-confidence answers

### UI Creativity for Content Rendering
- ‚úÖ Streaming Markdown with real-time updates
- ‚úÖ Syntax-highlighted code blocks
- ‚úÖ Tables, task lists, and rich formatting support
- ‚úÖ Citation drawer with source links
- ‚úÖ Per-message download options
- ‚úÖ Replayable conversation history

### Application Architecture and Scalability
- ‚úÖ Single Next.js app with internal job runner
- ‚úÖ Horizontal scaling ready (stateless design)
- ‚úÖ Database-backed persistence
- ‚úÖ Job queue for background tasks
- ‚úÖ Modular architecture (can split services later)
- ‚úÖ Cloud-agnostic containerized deployment

## New Features: Multimodal PDF Analysis & Chart Generation üìä

### Analyze Tables, Charts, and Diagrams

PaperTrail now uses **Gemini Vision API** to analyze visual content in your PDFs:

- **üìä Tables**: Automatically converted to Markdown format
- **üìà Charts**: Data extracted and explained in detail
- **üî¨ Diagrams**: Components and relationships described

### Interactive Chart Generation

Ask the AI to create visual charts from table data:

```
You: "Show me the treatment success rates as a pie chart"

AI: [Displays both the table AND an interactive pie chart]
```

**Supported Chart Types:**
- **Pie Charts** - Show proportions and percentages
- **Bar Charts** - Compare categories and groups
- **Line Charts** - Display trends over time

### How to Use

1. **Upload a PDF** with tables or charts
2. **Ask questions** like:
   - "What does Table 2 show?"
   - "Show me the results as a pie chart"
   - "Compare the groups with a bar chart"
3. **Get responses** with formatted tables AND interactive charts

### Documentation

- **[MULTIMODAL_FEATURES.md](MULTIMODAL_FEATURES.md)** - Complete technical guide
- **[CHART_GENERATION.md](CHART_GENERATION.md)** - Chart usage documentation
- **[CHART_EXAMPLES.md](CHART_EXAMPLES.md)** - Copy-paste example queries
- **[IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)** - Implementation details

## Project Structure

```
PaperTrail/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/              # API routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/         # Authentication endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/         # SSE streaming chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ threads/      # Thread management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documents/    # Document metadata
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search/       # Search functionality
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload/       # File upload handler
‚îÇ   ‚îú‚îÄ‚îÄ chat/             # Chat page
‚îÇ   ‚îú‚îÄ‚îÄ login/            # Login/signup page
‚îÇ   ‚îú‚îÄ‚îÄ components/       # React components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/           # Radix UI primitives
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chat/         # Chat-specific components
‚îÇ   ‚îú‚îÄ‚îÄ database/         # Database schema and client
‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts       # NextAuth config
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ azure-openai.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gemini.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pdf-processor.ts
‚îÇ   ‚îî‚îÄ‚îÄ hooks/            # Custom React hooks
‚îú‚îÄ‚îÄ drizzle/              # Database migrations
‚îú‚îÄ‚îÄ scripts/              # Utility scripts
‚îú‚îÄ‚îÄ public/               # Static assets
‚îú‚îÄ‚îÄ .env.example          # Environment template
‚îú‚îÄ‚îÄ drizzle.config.ts     # Drizzle ORM config
‚îú‚îÄ‚îÄ docker-compose.yml    # Docker Compose config
‚îú‚îÄ‚îÄ Dockerfile            # Container definition
‚îî‚îÄ‚îÄ next.config.ts        # Next.js configuration
```

## Contributing

This project was built as part of a technical assessment. Feel free to fork and extend!

## License

MIT

---

**PaperTrail** - Unifying PubMed, arXiv, and user documents into a single, reference-grounded conversational AI.